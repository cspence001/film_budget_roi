define(["require","exports","tslib","react","spectrum/button","spectrum/modal","modules/clean/ajax","modules/clean/teams/constants","modules/clean/teams/admin/widgets/open_team_join_onboarding_modal/open_team_join_onboarding_modal","modules/clean/analytics","modules/clean/components/loading_indicator","modules/clean/contacts/contact","modules/clean/contacts/tokenizer","modules/clean/contacts/types","modules/clean/dbmodal_stack","react-modal","modules/clean/loggers/join_flow_logger","modules/clean/react/payments/update_individual_billing/update_individual_store_creator","modules/clean/payments/skus/subscription_diff","modules/clean/payments/skus/subscription_service","modules/clean/payments/skus/subscription_status","modules/clean/teams/admin/widgets/update_billing_modal/update_billing_modal_loader","modules/clean/react/css","modules/clean/react/invite/invite_and_buy_text","modules/clean/react/modal","modules/clean/stormcrow/experiment","modules/clean/viewer","modules/core/browser","modules/core/browser_detection","modules/core/html","modules/core/i18n","modules/core/notify","modules/clean/user_education/user_education_client","external/lodash","dig-components/typography","modules/clean/ux_analytics_modal_tracking","modules/clean/ux_analytics_utils","modules/clean/react/payments/common/adapters/setup_cash","modules/clean/teams/admin/widgets/invite_modal/invite_link","modules/clean/teams/admin/api/admin_console_api_client","modules/clean/teams/admin/widgets/invite_modal/invite_modal_first_task/invite_modal_first_task","modules/clean/teams/admin/widgets/invite_modal/invite_modal_groups","modules/clean/react/member_sidebar_actions","modules/clean/growth/smb_funnel/smb_funnel_logger","modules/clean/react/admin/teams/onboarding/web/constants","modules/clean/api_v2/user_client","modules/clean/teams/admin/widgets/invite_modal/suggested_members","modules/clean/teams/admin/widgets/member_send_invite/member_invite_disclosure","modules/clean/contacts/async_contact_validation","modules/core/uri","modules/clean/teams/admin/widgets/invite_modal/invite_validation_message","modules/clean/teams/admin/widgets/invite_modal/invitability_state"],(function(e,t,i,n,s,a,o,r,l,m,u,d,c,g,_,v,p,f,h,b,M,S,I,L,y,E,A,T,w,C,k,x,O,R,P,N,F,D,V,B,W,U,q,j,z,G,J,Y,H,X,K,Z){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=i.__importDefault(n),o=i.__importStar(o),g=i.__importDefault(g),v=i.__importDefault(v),T=i.__importStar(T),w=i.__importStar(w),R=i.__importStar(R),B=i.__importDefault(B);var Q=k.intl.formatMessage({id:"mdbgLV",defaultMessage:"Not formatted quite right"}),$=k.intl.formatMessage({id:"T2Uxhd",defaultMessage:"Already invited by another team"}),ee=k.intl.formatMessage({id:"L7XWyH",defaultMessage:"Already on your team"}),te=k.intl.formatMessage({id:"iXkp+f",defaultMessage:"Account already deleted, but you can still restore it"}),ie=k.intl.formatMessage({id:"0BKjy6",defaultMessage:"Email hidden by another app. Try inviting them with a different email."}),ne=new Map([[Z.InvitabilityState.BYPASS.toString(),ee],[Z.InvitabilityState.REJECT_ON_DIFFERENT_TEAM.toString(),$],[Z.InvitabilityState.REJECT_ALREADY_PAIRED.toString(),ee],[Z.InvitabilityState.REJECT_MISC.toString(),$],[Z.InvitabilityState.REJECT_RECOVERABLE_USER.toString(),te],[Z.InvitabilityState.REJECT_APPLE_RELAY_EMAIL.toString(),ie]]);t.InvitabilityTooltips={INVALID_TOOLTIP:Q,OTHER_TEAM_TOOLTIP:$},v.default.setAppElement(document.body),t.EMAIL_REGEX=/['&A-Za-z0-9\._%+-]+@[A-Za-z0-9-][A-Za-z0-9\.-]*\.[A-Za-z]{2,15}/gi;var se=(function(e){function v(a){var v=e.call(this,a)||this;if(v._isMounted=!1,v.closeModal=function(e,t,i){var s=v.props.onDismiss;if(window.setTimeout((function(){O.UEClient.sendEvent("InviteModal","Hide")}),2500),s?null==s||s(v.state.memberList):y.Modal.close(),e&&e(v.state.memberList),t&&void 0!==i&&i.length>0){var a=v.viewer.work_user.id;y.Modal.showInstance(n.default.createElement(l.OpenTeamJoinOnboardingModal,{domains:i,userId:a}))}},v.onBillingClick=function(e){e.stopPropagation(),e.preventDefault();var s=v.state,a=s.emails,o=s.inviteMessage,r=function(){y.Modal.showInstance(n.default.createElement(t.InviteModal,i.__assign({},v.props,{emails:a,inviteMessage:o,onDismiss:void 0}))),_.DBModalStack.unregister(f.BILLING_INFO_UPDATED,r)};v.closeModal(),_.DBModalStack.register(f.BILLING_INFO_UPDATED,r),S.UpdateBillingModalLoader.showInstance(r)},v.onSubServiceResponse=function(e,t,i,n){v.setState({emails:t,isMakingTransitionInfoRequest:!1,isPreparingForSubmit:!1,numRemainingLicenses:i-n-t.length,subChangePlan:e})},v.onContactsChanged=function(e,t){var n=v.state,s=n.isReseller,a=n.isSelfServe,o=n.numProvisionedLicenses,r=n.isLoading,l=n.emails,m=n.sentEmails,u=v.props.isIMMRevampM1On;if(!r){v.setState({isEmailTextInputted:e.length>0||t.length>0,contacts:e});var d=e.map((function(e){return e.email})).filter((function(e){return void 0!==e})),c={emails:d,isPreparingForSubmit:!1,numRemainingLicenses:v.totalLicenses-o-d.length-m.length};!s&&a&&d.length!==l.length&&d.length+o>v.totalLicenses?v.updateSubChangePlan(d.length+o,i.__assign(i.__assign({},c),{totalLicenses:u?v.totalLicenses:void 0,numProvisionedLicenses:u?o:void 0})):v.setState(c)}},v.onMessageChanged=function(e){v.setState({inviteMessage:e.target.value})},v.sendInviteAction=function(){if(v.contactsTokenizer){var e=v.state.emails,t=v.contactsTokenizer.getContacts();e.length!==t.length?v.setState({isPreparingForSubmit:!0},(function(){v.contactsTokenizer.tokenizeAll()})):v.sendMemberInvites()}else v.sendMemberInvites()},v.onPrimaryActionClick=function(){!v.showInviteLink()&&!v.props.isAfterUninvite||v.growthActSmbFirstTask.isActive?v.sendInviteAction():v.shouldRenderSendInviteAction?v.sendInviteAction():v.closeModal()},v.onSecondaryActionClick=function(){var e=v.state,t=e.emails,n=e.suggestedMembers,s=e.suggestedMembersSuggestId,a=e.numRemainingLicenses,o={};if(v.shouldShowSuggestionsInIMM()&&n&&n.length){var r=R.filter(n,(function(e){return-1!==t.indexOf(e.email)}));o.total_recommendations=n.length,o.num_selected_recommendations=r.length,o.suggest_id=s,o.num_licenses_available=a}m.TeamsWebActionsLogger.log("invite_member_open_cancel",i.__assign(i.__assign(i.__assign({},v.defaultLoggingExtras),o),{added_message:v.hasInviteMessage,invite_count:v.inviteCount,invite_or_buy:v.inviteOrBuyText})),v.closeModal()},v.logSmbFunnel=function(e,t){void 0===t&&(t={});var n=v.growthActSmbFirstTask.isActive,s=v.growthActSmbGroupsFirst.isActive,a=v.growthActSmbMWInvites.isActive;(n||s||a)&&j.SMBFunnelLogger.log(e,i.__assign(i.__assign({},t),{first_task:String(n),groups_first:String(s),mv_invites:String(a)}))},v.sendMemberInvites=function(){var e=v.state,n=e.emails,s=e.groupIds,a=e.inviteMessage,l=e.numRemainingLicenses,u=e.subChangePlan,d=e.sentEmails,c=e.memberList,g=e.suggestedMembers,_=v.props.isIMMRevampM1On,f=l<0?-1*l:0,h={charge_for_new_licenses:!0,custom_message:a,emails:n,group_ids:s,expected_overage:String(f),expected_price:"0",extra:JSON.stringify(i.__assign({},v.defaultLoggingExtras)),url:T.get_uri().path,invite_source:p.InviteSource.IMM_WEB,platform:p.Platform.WEB,skip_invalid_invitees:Boolean(_)};if(u&&u.tvm&&(h.expected_price=u.tvm.transition.expected_price),m.TeamsWebActionsLogger.log("invite_member_open_invite_click",i.__assign(i.__assign({},v.defaultLoggingExtras),{added_message:v.hasInviteMessage,expected_price:h.expected_price,invite_count:v.inviteCount,invite_or_buy:v.inviteOrBuyText,licenses_to_add:f,group_ids:s})),0===n.length)return x.Notify.error(k.intl.formatMessage({id:"E/vNT2",defaultMessage:"You havenâ€™t included anyone to invite! Please invite at least one person."})),void m.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},v.defaultLoggingExtras),{client:!0,error_reason:"no_invites",invite_or_buy:v.inviteOrBuyText,group_ids:s}));for(var b=0,M=n;b<M.length;b++){var S=M[b].toLowerCase().split("@",2)[1];if(-1!==["getdropbox.com","dropboxmail.com"].indexOf(S))return x.Notify.error(k.intl.formatMessage({id:"ffW3Dm",defaultMessage:"You are not allowed to invite a member with a {domain} email."},{domain:S})),void m.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},v.defaultLoggingExtras),{client:!0,error_reason:"invite with dropbox domain",invite_or_buy:v.inviteOrBuyText,group_ids:s}))}v.props.shouldNotToastOnSuccess||x.Notify.success(k.intl.formatMessage({id:"uBRRiV",defaultMessage:"Submitting..."})),v.setState({isSubmitting:!0},(function(){var e=Date.now(),a=A.Viewer.get_viewer().work_user;o.FormWebRequest({url:"/account/team/add_users",data:h,subject_user:a,success:function(t){var a=JSON.parse(t);if(x.Notify.clear(),v.setState({isSubmitting:!1}),m.TeamsWebActionsLogger.log("team_admin_add_member_submit_time",i.__assign(i.__assign({},v.defaultLoggingExtras),{time_ms:Date.now()-e})),a){var u=a.users,_=a.has_invalid_invites,p=Object.keys(u),f=p.length,h=p.map((function(e){return u[e].email})),b=n.filter((function(e){return-1===h.indexOf(e)})).length,M=a.show_open_team_join_onboarding_modal,S=a.team_domains;if(c.length&&(v.growthActSmbGroupsFirst.isActive||v.growthActSmbFirstTask.isActive)&&!_){var I=c[0],L=c.slice(1),y=p.map((function(e){return{admin_role:r.ADMIN_ROLE.NONE,initials:u[e].email[0].toUpperCase(),photo_url:null,display_name:u[e].email,email:u[e].email,team_join_state:q.JoinState.PENDING,user_id:u[e].id}}));v.setState({numRemainingLicenses:l-d.length,sentEmails:d.concat(y),emails:[],memberList:i.__spreadArrays([I],y,L)},(function(){v.growthActSmbGroupsFirst.isActive&&v.closeModal()}))}else v.props.onInviteSuccess&&v.props.onInviteSuccess(a.num_invited,l<0?-1*l:0),!0===_?v.removeInvitedContactsAfterInvites(h):v.closeModal(void 0,M,S);if(m.TeamsWebActionsLogger.log("invite_member_open_invite_success",i.__assign(i.__assign({},v.defaultLoggingExtras),{added_message:v.hasInviteMessage,invite_count:v.inviteCount,invite_or_buy:v.inviteOrBuyText,members_length:c.length,group_ids:s})),v.logSmbFunnel(z.AMPMetrics.ACTIVATION_IMM_ADD_MEMBERS,{success:"true",numInvited:String(f),membersLength:String(c.length)}),v.shouldShowSuggestionsInIMM()&&g&&g.length)for(var E=0,A=R.filter(g,(function(e){return-1!==n.indexOf(e.email)}));E<A.length;E++){var T=A[E];m.TeamsWebActionsLogger.log("admin_invite_recommended_contact",{user_id:T.user_id,team_type:T.team_type,prediction_id:T.prediction_id,num_licenses_available:l,origin:"imm_recommendation",inviteModal:!0})}!0===_?0===f?x.Notify.error(k.intl.formatMessage({id:"LYHTOV",defaultMessage:"Invites couldn't be sent. Fix any issues, and try sending them again."})):x.Notify.warning(k.intl.formatMessage({id:"HUpgUr",defaultMessage:"Some invites sent. Fix any issues, and try the last {numNotInvited} again."},{numNotInvited:b})):v.props.shouldNotToastOnSuccess||(1===f?x.Notify.success(k.intl.formatMessage({id:"klqzm6",defaultMessage:"Invited {user_email}."},{user_email:u[p[0]].email})):f>1?x.Notify.success(k.intl.formatMessage({id:"A+luT2",defaultMessage:"Invited {user_count} people."},{user_count:f})):x.Notify.error(k.intl.formatMessage({id:"9fLrh/",defaultMessage:"{count, plural, one{Skipped {count} person who is already a member of the team.} other{Skipped {count} people who are already members of the team.}}"},{count:b}))),o.SilentBackgroundRequest({url:"/account/team/ajax_log_invites",data:{invitations:f}})}else v.props.onInviteError&&v.props.onInviteError(),x.Notify.error(k.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."})),v.logSmbFunnel(z.AMPMetrics.ACTIVATION_IMM_ADD_MEMBERS,{success:"false",errorReason:"response_empty"})},error:function(n,a,o){x.Notify.clear(),v.setState({isSubmitting:!1}),m.TeamsWebActionsLogger.log("team_admin_add_member_submit_time",i.__assign(i.__assign({},v.defaultLoggingExtras),{time_ms:Date.now()-e,error:!0})),v.logSmbFunnel(z.AMPMetrics.ACTIVATION_IMM_ADD_MEMBERS,{success:"false",errorReason:"request_error"});var r=k.intl.formatMessage({id:"/GekxI",defaultMessage:"There was a problem completing this request."});if(o)try{var l=JSON.parse(o).emails,u=void 0===l?{}:l;if(u.message_text){r=u.message_text;var d=i.__assign({err_msg:r.replace(t.EMAIL_REGEX,"***")},v.defaultLoggingExtras);m.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},d),{client:!0,error_reason:"form_input_invalid",invite_or_buy:v.inviteOrBuyText,group_ids:s}))}}catch(e){r=o}else m.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},v.defaultLoggingExtras),{client:!0,error_reason:"problem_request",invite_or_buy:v.inviteOrBuyText,group_ids:s}));v.props.onInviteError&&v.props.onInviteError(),x.Notify.error(new C.HTML(r))}})}))},v.renderPrimaryAction=function(e,t){var i=v.state,a=i.isReseller,o=i.numRemainingLicenses,r=i.isSubmitting,l=i.isSelfServe,m=i.memberList,d=v.props.isRequestSuggestion,c=v.isInviteButtonDisabled,g=k.intl.formatMessage({id:"yzFoXG",defaultMessage:"Send invites"});return o<0&&!a&&!v.isNCCT&&l&&!m.length&&(g=k.intl.formatMessage({id:"dljqTf",defaultMessage:"Invite and buy"})),!0===d&&(g=k.intl.formatMessage({id:"597Ndb",defaultMessage:"Confirm"})),!v.showInviteLink()&&!v.props.isAfterUninvite||v.shouldRenderSendInviteAction||v.growthActSmbFirstTask.isActive||(g=k.intl.formatMessage({id:"XEaqiT",defaultMessage:"Done"}),c=!1),n.default.createElement(s.Button,{className:"invite-modal__send-invites",ref:t,variant:"primary",disabled:c,onClick:e},n.default.createElement("span",{className:"modal-button-wrapper"},g,r&&n.default.createElement("span",{className:"loading-indicator"},n.default.createElement(u.LoadingIndicator,{style:u.LoadingIndicator.LoadingIndicatorStyle.SPINNER}))))},v.renderSecondaryAction=function(e){var t=k.intl.formatMessage({id:"d9/SE1",defaultMessage:"Cancel"});return n.default.createElement(s.Button,{variant:"secondary",onClick:e},t)},v.contactFilter=function(e){return e.type===g.default.EMAIL},v.renderContactsTokenizer=function(e,t,i){if(void 0===t&&(t=k.intl.formatMessage({id:"Le5Iez",defaultMessage:"Name or email"})),void 0===i&&(i=8),e){var s,a=v.state,o=a.isLoading,r=a.contacts,l=a.emails,m=a.validatedContactMap,u=v.props.isIMMRevampM1On;s=l.map((function(e){return new d.Contact({name:e,email:e,type:g.default.EMAIL,invalid:!1,on_team:!1,pending:!0,query:e})}));var _=u?n.default.createElement(K.InviteValidationMessage,{contacts:r}):null;return n.default.createElement("div",{className:"invite-modal__tokenizer"},n.default.createElement(c.ContactsTokenizer,{customClass:o?"disabled":"",customContactFilter:v.contactFilter,disabled:o,onContentsChange:v.onContactsChanged,placeholder:t,populatedInputData:{tokens:!0===u?r:s,value:""},ref:function(e){v.contactsTokenizer=e},showContactImport:!1,tokenSpacing:i,user:e,listHeight:81,tokenizeOnOutOfFocus:!0,asyncValidateContacts:!0===u?v.asyncEmailsValidation:void 0,customContactValidator:!0===u?v.contactValidator:void 0,validatedContactMap:!0===u?m:void 0}),_)}},v.shouldFetchSuggestionsInIMM=function(){var e=v.props.suggestionsInImmVariant;return e&&["ON","CONTROL"].includes(e)},v.shouldShowSuggestionsInIMM=function(){return"ON"===v.props.suggestionsInImmVariant},v.checkboxCallback=function(e,t){var n=v.state,s=n.emails,a=n.isReseller,o=n.numProvisionedLicenses,r=n.sentEmails,l=n.suggestedMembers,u=n.numRemainingLicenses,d=R.find(l,(function(e){return e.email===t})),c=s.slice();e?(c.push(t),m.TeamsWebActionsLogger.log("admin_select_recommended_contact",{user_id:d.user_id,team_type:d.team_type,prediction_id:d.prediction_id,num_licenses_available:u,origin:"imm_recommendation"})):(c=c.filter((function(e){return e!==t})),m.TeamsWebActionsLogger.log("admin_deselect_recommended_contact",{user_id:d.user_id,team_type:d.team_type,prediction_id:d.prediction_id,num_licenses_available:u,origin:"imm_recommendation"})),v.setState({isEmailTextInputted:c.length>0,emails:c});var g={emails:c,isPreparingForSubmit:!1,numRemainingLicenses:v.totalLicenses-o-c.length-r.length};!a&&c.length+o>v.totalLicenses?v.updateSubChangePlan(c.length+o,i.__assign(i.__assign({},g),{totalLicenses:v.totalLicenses,numProvisionedLicenses:o})):v.setState(g)},v.closeAndOpenCSVImportModal=function(){var e=v.props,t=e.onCSVImport,i=e.onDismiss;m.TeamsWebActionsLogger.log("import_csv_modal_open",v.defaultLoggingExtras),t&&(v.closeModal(i),t())},v.showInviteLink=function(){return v.state.doesUserHavePermissionsToManageInviteLink&&v.props.shouldShowInviteLink&&!v.state.isEmailTextInputted},v.contactValidator=function(e){return v.isContactInvalid(e)?{state:c.ContactTokenState.invalid,msg:ne.get(e.invitability_state||"")||Q}:{state:c.ContactTokenState.ok,msg:null}},v.asyncEmailsValidation=function(e){return i.__awaiter(v,void 0,Promise,(function(){var t,n;return i.__generator(this,(function(s){switch(s.label){case 0:return[4,H.asyncInviteeEmailsValidation(e)];case 1:return t=s.sent(),!0===this._isMounted&&(n=this.state.validatedContactMap,this.setState({validatedContactMap:new Map(i.__spreadArrays(Array.from(n),Array.from(t)))})),[2]}}))}))},v.subService=new b.SubscriptionService,v.apiClient=new B.default,v.state={emails:a.emails||[],groupIds:[],inviteMessage:a.inviteMessage||"",isEmailTextInputted:!!a.emails&&a.emails.length>0||!1,isLoading:!0,isMakingTransitionInfoRequest:!1,isPreparingForSubmit:!1,isSubmitting:!1,numProvisionedLicenses:0,numRemainingLicenses:0,showInviteLink:!1,showSidebar:!!a.memberList&&1===a.memberList.length&&!v.growthActSmbMWInvites.isActive,memberList:a.memberList||[],sentEmails:[],isJustInTimeLicensingEnabled:!1,contacts:[],validatedContactMap:new Map,doesUserHavePermissionsToManageInviteLink:!1},v.defaultLoggingExtras={is_client:!1,origin:v.props.origin,groups:v.growthActSmbGroupsFirst.isActive},v.props.actionTrigger){v.defaultLoggingExtras.action_trigger=v.props.actionTrigger,v.defaultLoggingExtras.module_name="first_task_imm",v.defaultLoggingExtras.framework="team_setup_essential",v.defaultLoggingExtras.mobile_web=w.is_supported_mobile_browser();var h=v.defaultLoggingExtras.mobile_web?j.Platform.MOBILE_WEB:j.Platform.WEB;j.SMBFunnelLogger.setCommonTags({platform:h})}return v}return i.__extends(v,e),Object.defineProperty(v.prototype,"isInviteButtonDisabled",{get:function(){var e=this.state,t=e.isLoading,i=e.isMakingTransitionInfoRequest,n=e.isReseller,s=e.isSelfServe,a=e.isSubmitting,o=e.numRemainingLicenses,r=this.props.isIMMRevampM1On;return t||i||a||n&&o<0||!s&&o<0||0===(r?this.validInviteCount:this.inviteCount)&&this.contactsTokenizer&&0===this.contactsTokenizer.getInputValue().length},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"hasInviteMessage",{get:function(){return Boolean(this.state.inviteMessage)},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"inviteCount",{get:function(){return this.state.emails.length},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"inviteOrBuyText",{get:function(){return this.state.numRemainingLicenses<0?"invite_buy":"send_invites"},enumerable:!0,configurable:!0}),v.prototype.relaunchFirstTaskModal=function(e){var t=this.props.onDismiss;t&&t(e,!0)},v.prototype.componentDidUpdate=function(e,t){var i=this.state,n=i.emails,s=i.isPreparingForSubmit;i.numRemainingLicenses>=n.length&&t.isPreparingForSubmit&&!s&&this.sendMemberInvites()},v.prototype.componentWillUnmount=function(){this._isMounted=!1,F.dispatchModalClosed()},v.prototype.componentDidMount=function(){var e=this;this._isMounted=!0;var t=this.props,n=t.onDismiss,s=t.isIMMRevampM1On;o.WebRequest({url:"/team/admin/members/invite_members_modal_view_model",subject_user:A.Viewer.get_viewer().work_user,success:function(t){var n,a,o=JSON.parse(t),r=o.isReseller,l=o.numActiveTeamMembers,u=o.provisionedLicenses,d=o.currencyToFormatMap,c=o.localeNumberFormat,g=o.showMemberInviteDisclaimer,_=o.isJustInTimeLicensingEnabled,v=o.doesUserHavePermissionsToManageInviteLink,p=void 0===o.isSelfServe||o.isSelfServe;if(r){var f=o.resellerContact,h=o.serializedResellerSubSkuSet;n=(a=h.licenseSkus[0].quantity)-u,e.setState({isLoading:!1,isReseller:r,isSelfServe:p,numActiveTeamMembers:l,numProvisionedLicenses:u,numRemainingLicenses:n,resellerContact:f,serializedResellerSubSkuSet:h,showMemberInviteDisclaimer:g,isJustInTimeLicensingEnabled:_,doesUserHavePermissionsToManageInviteLink:v},(function(){var t;e.showInviteLink()&&(t=e.props.inviteLinkUrl?"ON":"OFF"),m.TeamsWebActionsLogger.log("invite_member_open",i.__assign(i.__assign({},e.defaultLoggingExtras),{invite_or_buy:e.inviteOrBuyText,license_limit:a,num_team_members:l,provisioned_licenses:u,url:T.get_uri().path,link_status:t})),e.setInitialSubChangePlan()}))}else{var b=M.SubscriptionStatus.deserialize(o.serializedSubStatus);n=(a=!0===s?b.finalSubState.totalLicenses:b.subState.totalLicenses)-u-e.state.emails.length-e.state.sentEmails.length,e.fetchSuggestions(),e.setState({isReseller:r,isSelfServe:p,numActiveTeamMembers:l,numProvisionedLicenses:u,numRemainingLicenses:n,subStatus:b,showMemberInviteDisclaimer:g,isJustInTimeLicensingEnabled:_,doesUserHavePermissionsToManageInviteLink:v},(function(){var t;e.showInviteLink()&&(t=e.props.inviteLinkUrl?"ON":"OFF"),m.TeamsWebActionsLogger.log("invite_member_open",i.__assign(i.__assign({},e.defaultLoggingExtras),{invite_or_buy:e.inviteOrBuyText,license_limit:a,num_team_members:l,provisioned_licenses:u,url:T.get_uri().path,link_status:t})),e.setInitialSubChangePlan()}))}D.setupCash(c,d),F.dispatchModalOpened()},error:function(t){x.Notify.error(k.intl.formatMessage({id:"C2BKnZ",defaultMessage:"Failed to load modal."})),e.closeModal(n)}})},Object.defineProperty(v.prototype,"totalLicenses",{get:function(){var e=this.state,t=e.isReseller,i=e.serializedResellerSubSkuSet,n=e.subStatus,s=this.props.isIMMRevampM1On;return t?i.licenseSkus[0].quantity:n?!0===s?n.finalSubState.totalLicenses:n.subState.totalLicenses:void 0},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"viewer",{get:function(){return A.Viewer.get_viewer()},enumerable:!0,configurable:!0}),v.prototype.setInitialSubChangePlan=function(){var e=this.props.emails,t=this.state.numProvisionedLicenses;if(!e)return this.setState({isLoading:!1});e.length+t>this.totalLicenses?this.updateSubChangePlan(e.length+t,{emails:e,numProvisionedLicenses:t,totalLicenses:this.totalLicenses},{isLoading:!1}):this.setState({isLoading:!1})},v.prototype.updateSubChangePlan=function(e,t,n){var s=this;void 0===n&&(n={});var a=h.SubscriptionDiff.fromSubscriptionStatus(this.state.subStatus);a.setTotalLicenses(e),this.setState({isMakingTransitionInfoRequest:!0},(function(){var e=Date.now();s.subService.price(a).then((function(a){var o=t.emails,r=t.totalLicenses,l=t.numProvisionedLicenses;s.onSubServiceResponse(a,o,r,l),R.isEmpty(n)||s.setState(n),m.TeamsWebActionsLogger.log("invite_member_billing_load_time_new_imm",i.__assign(i.__assign({},s.defaultLoggingExtras),{time_ms:Date.now()-e}))}))}))},v.prototype.removeInvitedContactsAfterInvites=function(e){var t=this.state,i=t.contacts,n=t.emails,s=i.filter((function(t){return t.email&&!e.includes(t.email)})),a=n.filter((function(t){return!e.includes(t)}));this.setState({contacts:s,emails:a})},Object.defineProperty(v.prototype,"shouldRenderSendInviteAction",{get:function(){return this.state.isEmailTextInputted},enumerable:!0,configurable:!0}),v.prototype.renderAltAction=function(e){var t=this.state.numRemainingLicenses;return!this.isNCCT&&t&&t<0?this.renderPricingInformation():null},v.prototype.renderForm=function(){var e=this.state,t=e.inviteMessage,i=e.isLoading,s=e.isEmailTextInputted,a=e.emails,o=e.suggestedMembers,r=this.shouldShowSuggestionsInIMM()&&o&&!!o.length,l=this.showInviteLink(),m=!r&&!l||s,u=k.intl.formatMessage({id:"KM5lP0",defaultMessage:"Or invite with an email"});return n.default.createElement("form",{className:"invite-modal__form"},l&&n.default.createElement("p",{className:"invite-modal__form_title"},u),this.renderContactsTokenizer(this.viewer.work_user),m&&n.default.createElement("div",null,n.default.createElement("textarea",{className:"invite-modal__message-input",disabled:i,id:"message-input",onChange:this.onMessageChanged,placeholder:k.intl.formatMessage({id:"D4+6Xw",defaultMessage:"Add an optional message"}),value:t}),n.default.createElement("label",{className:"message-input-label",htmlFor:"message-input"},k.intl.formatMessage({id:"N6BsJQ",defaultMessage:"Invite message"}))),r&&n.default.createElement(J.SuggestedMembersCheckboxes,{emails:a,toggleCheckboxCallback:this.checkboxCallback,suggestions:o,disabled:this.state.isMakingTransitionInfoRequest}))},v.prototype.renderLicensesRemainingText=function(){var e,t=this.state,i=t.emails,n=t.isReseller,s=t.numRemainingLicenses,a=t.resellerContact,o=t.isSelfServe,r=i.length,l=this.showInviteLink();if(this.isNCCT)return null;if(0===r)return 0===s?(e=k.intl.formatMessage({id:"Jdo+KG",defaultMessage:"You have no remaining licenses."}),l&&(e=k.intl.formatMessage({id:"ztOAKn",defaultMessage:"You have no licenses available"}))):(e=k.intl.formatMessage({id:"kPEGPd",defaultMessage:"{count, plural, one{You have {count} remaining license.} other{You have {count} remaining licenses.}}"},{count:s}),l&&(e=k.intl.formatMessage({id:"1wqEdn",defaultMessage:"{count, plural, one{You have {count} available license.} other{You have {count} available licenses.}}"},{count:s}))),e;if(s<0)return e=n&&a?a.name&&a.phone?k.intl.formatMessage({id:"MahXPc",defaultMessage:"{count, plural, one{You need more licenses for this invitation. Contact {name} at {phone} to add more.} other{You need more licenses for these invitations. Contact {name} at {phone} to add more.}}"},{count:r,name:a.name,phone:a.phone}):k.intl.formatMessage({id:"MeCUMG",defaultMessage:"{count, plural, one{You need more licenses for this invitation. Contact your reseller to add more.} other{You need more licenses for these invitations. Contact your reseller to add more.}}"},{count:r}):o?k.intl.formatMessage({id:"bSWJau",defaultMessage:"{count, plural, one{You need more licenses for this invitation.} other{You need more licenses for these invitations.}}"},{count:r}):k.intl.formatMessage({id:"PYe+Gn",defaultMessage:"{count, plural, one{You need more licenses for this invitation. Please contact your account executive to purchase licenses.} other{You need more licenses for these invitations. Please contact your account executive to purchase licenses.}}"},{count:r});var m=k.intl.formatMessage({id:"TyEk+t",defaultMessage:"{count, plural, one{After this invitation} other{After these invitations}}"},{count:r});return e=0===s?k.intl.formatMessage({id:"WOvbOS",defaultMessage:"{invitation_msg}, youâ€™ll have no remaining licenses."},{invitation_msg:m}):k.intl.formatMessage({id:"gTZ9A1",defaultMessage:"{count, plural, one{{invitation_msg}, youâ€™ll have {count} remaining license.} other{{invitation_msg}, youâ€™ll have {count} remaining licenses.}}"},{invitation_msg:m,count:s})},v.prototype.renderPricingInformation=function(){var e=this.state,t=e.numRemainingLicenses,i=e.subChangePlan,s=e.subStatus,a=e.isMakingTransitionInfoRequest,o=this.props.isRequestSuggestion;return s&&i&&i.finalSubState.billingSchedule?a?n.default.createElement("div",{className:!0===o?"invite-modal__invite-and-buy--request-suggestion":"invite-modal__invite-and-buy--email-invite"},n.default.createElement(u.LoadingIndicator,{style:u.LoadingIndicator.LoadingIndicatorStyle.SPINNER})):i.tvm?n.default.createElement("div",{className:!0===o?"invite-modal__invite-and-buy--request-suggestion":"invite-modal__invite-and-buy--email-invite"},n.default.createElement(L.InviteAndBuyText,{className:"invite-modal__invite-and-buy-text u-font-meta",additionalLicenses:-1*t,isTrial:s.isOnTrial,nextBillingDate:s.formattedNextBillingDate,subChangePlan:i}),n.default.createElement("a",{href:"#",className:"invite-modal__update-billing-link",onClick:this.onBillingClick},k.intl.formatMessage({id:"tbFeQQ",defaultMessage:"Update billing"}))):null:null},Object.defineProperty(v.prototype,"isNCCT",{get:function(){var e=this.state.subStatus;return!!e&&(e.isOnTrial&&E.Experiment(this.props.ncctVariant).variantIn("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10","V11","V12","V13"))},enumerable:!0,configurable:!0}),v.prototype.fetchSuggestions=function(){var e=this;if(this.shouldFetchSuggestionsInIMM()){var t=A.Viewer.get_viewer().work_user;if(t)(new G.UserApiV2Client).ns("team_experience").rpc("teammate_suggestions/list",void 0,{subjectUserId:t.id}).then((function(t){var i=t.recommended_members.members.slice(0,2);m.TeamsWebActionsLogger.log("admin_recommendations_shown_imm",{num_recommendations:i.length,suggest_id:t.suggest_id,origin:e.props.origin});for(var n=0,s=i;n<s.length;n++){var a=s[n];m.TeamsWebActionsLogger.log("admin_display_recommended_contact",{user_id:a.user_id,team_type:a.team_type,prediction_id:a.prediction_id,origin:"imm_recommendation"})}e.setState({suggestedMembers:i,suggestedMembersSuggestId:t.suggest_id})}))}},Object.defineProperty(v.prototype,"growthActSmbFirstTask",{get:function(){return E.Experiment(this.props.experiments.growthActSmbFirstTask)},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"growthActSmbGroupsFirst",{get:function(){return E.Experiment(this.props.experiments.growthActSmbGroupsFirst)},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"growthActSmbMWInvites",{get:function(){return E.Experiment(this.props.experiments.growthActSmbMWInvites)},enumerable:!0,configurable:!0}),v.prototype.sendGroupInvites=function(e,t){this.setState({emails:e,groupIds:t},this.sendMemberInvites)},v.prototype.isContactInvalid=function(e){return Boolean(!0===e.invalid||e.invitability_state&&ne.has(e.invitability_state))},Object.defineProperty(v.prototype,"validInviteCount",{get:function(){var e=this,t=0;return this.state.contacts.forEach((function(i){e.isContactInvalid(i)||t++})),t},enumerable:!0,configurable:!0}),v.prototype.render=function(){var e=this,t=this.props,i=t.isOpen,s=t.customClass,o=t.inviteLinkUrl,r=t.inviteLinkExpiredTs,l=t.inviteToken,m=t.nextInviteLinkUrl,d=t.csvImportLabel,c=t.onCSVImport,g=t.tieredAdmin,_=t.width,v=void 0===_?699:_,p=t.ncctNoBillingInfo,f=t.isInviteLinkEnabled,h=t.isRequestSuggestion,b=t.evhMaxDays,M=t.isAfterUninvite,S=this.state,I=S.numRemainingLicenses,L=S.emails,y=S.isSubmitting,E=S.memberList,A=S.showSidebar,w=S.sentEmails,C=S.showMemberInviteDisclaimer,x=this.showInviteLink(),O=k.intl.formatMessage({id:"/KqWDm",defaultMessage:"Invite members to your team"});!0===h?O=k.intl.formatMessage({id:"v0b6+E",defaultMessage:"Confirm License Purchase"}):!0===M&&(O=k.intl.formatMessage({id:"RwO5iU",defaultMessage:"Invite someone else to the team"}));var F=this.shouldRenderSendInviteAction||!x&&!M,D=X.URI.parse(T.get_href()).getQuery().role;if(this.growthActSmbGroupsFirst.isActive)return n.default.createElement(U.GroupsInviteModal,{open:!!i,isSubmitting:y,memberList:E,handleOnClose:this.closeModal,handleCSVImport:this.closeAndOpenCSVImportModal,sendInvites:function(t,i){return e.sendGroupInvites(t,i)}});if(this.growthActSmbFirstTask.isActive&&E.length){return n.default.createElement(W.FirstTaskInviteModal,{open:!!i,tieredAdmin:g,memberList:E,showSidebar:A,emails:L,sentEmails:w,handleOnClose:this.closeModal,onCSVImport:c,handleOnSubmit:this.onPrimaryActionClick,handleCSVImport:this.closeAndOpenCSVImportModal,renderInputForm:this.renderContactsTokenizer,renderSubmitBtn:this.renderPrimaryAction,loggingExtras:this.defaultLoggingExtras,evhMaxDays:b,relaunchModal:function(t){return e.relaunchFirstTaskModal(t)},updateMemberList:function(t){return e.setState({memberList:t})},showImportCSV:!1,growthActSmbMWInvitesActive:this.growthActSmbMWInvites.isActive,isInviteLinkEnabled:f,showMemberInviteDisclaimer:C,role:D})}var B=null;!0===h&&1===L.length&&(B=n.default.createElement(P.Text,{isBold:!0},k.intl.formatMessage({id:"s8Jlo1",defaultMessage:"Approving membership request for {email}"},{email:L[0]})));var q=x?n.default.createElement(V.InviteLink,{numRemainingLicenses:I,inviteLinkUrl:o,inviteLinkExpiredTs:r,inviteToken:l,nextInviteLinkUrl:m,teamRoutes:this.apiClient.teamRoutes(),emails:L,onInviteLinkCreateStart:this.props.onInviteLinkCreateStart,onInviteLinkCreateEnd:this.props.onInviteLinkCreateEnd,onInviteLinkDelete:this.props.onInviteLinkDelete,onUpdateModal:this.props.onUpdateModal,isTrial:R.get(this.state.subStatus,"isOnTrial"),showAddLicenses:this.props.showAddLicenses,isNcct:this.isNCCT&&(null==p||p),isJustInTimeLicensingEnabled:this.state.isJustInTimeLicensingEnabled}):null,j=n.default.createElement("hr",{className:"invite-modal__invite_link_divider"}),z=n.default.createElement(n.default.Fragment,null,x&&n.default.createElement(n.default.Fragment,null,q,j),!0===h&&null!==B?B:this.renderForm(),this.renderAltAction());return n.default.createElement(a.UtilityModal,{ariaLabel:k.intl.formatMessage({id:"TuViF7",defaultMessage:"Invite Members"}),className:"invite-modal "+s,onPrimaryAction:this.onPrimaryActionClick,onSecondaryAction:this.onSecondaryActionClick,open:!0,overlayClickClose:!0,primaryAction:this.state.isLoading?function(){return n.default.createElement(n.default.Fragment,null)}:this.renderPrimaryAction,secondaryAction:F?this.renderSecondaryAction:void 0,title:O,width:v+"px",link:d,onLink:c?this.closeAndOpenCSVImportModal:void 0,overlayClassName:"file-viewer-modal-overlay"},this.state.isLoading&&n.default.createElement("div",{className:"invite-modal__loading-spinner"},n.default.createElement(u.LoadingIndicator,{style:u.LoadingIndicator.LoadingIndicatorStyle.DOTS})),!this.state.isLoading&&n.default.createElement(n.default.Fragment,null,n.default.createElement(N.UXAnalyticsModalTracking,{id:"invite-modal"}),n.default.createElement("div",{className:"invite-modal__content"},!0===h?null:n.default.createElement("p",{id:"invite-modal__form-license-msg"},this.renderLicensesRemainingText()),z,C&&n.default.createElement(Y.MemberInviteDisclosure,{role:D}))))},v.defaultProps={experiments:{growthActSmbFirstTask:"OFF",growthActSmbGroupsFirst:"OFF",growthActSmbMWInvites:"OFF"},inviteMessage:"",emails:[]},v})(n.default.Component);t.InviteModalView=se,t.InviteModal=I.requireCssWithComponent(se,["/static/css/spectrum/index.web-vfl6Z83yw.css","/static/js/spectrum-sharing/index.web-vflys06fP.css","/static/css/teams/admin/widgets/invite_modal/invite_modal-vfldOh5dX.css"])}));
//# sourceMappingURL=invite_modal.min.js-vfla5s644.map